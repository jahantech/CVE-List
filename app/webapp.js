var express = require('express');
var bodyParser = require('body-parser');
var PORT = 8080;
var app = express();
var mysql = require('mysql');
var randomstring = require("randomstring");
var compression = require('compression')
var express = require('express')
app.use(compression()); 

app.use(bodyParser.urlencoded({
        extended: false
}));

app.use(bodyParser.json());
app.use('/', express.static('static'));
app.get('/list', function(req, res) {
var connection = mysql.createConnection({
	host     : '127.0.0.1',
	user     : 'root',
	password : '',
	database : 'vulner_stats'
});
	connection.connect();

	connection.query('SELECT vuln_id, vuln_pub_date, vuln_score, vuln_products, vuln_summary from vulnerabilities WHERE vuln_pub_date >= DATE(NOW()) - INTERVAL 7 DAY order by vuln_pub_date DESC LIMIT 400', function(err, rows, fields) {
		if (err){
			res.status(500).send("Server Error");
		}
		connection.end();
		res.json(rows);
	});
});


app.post('/subscribe',function(req, res){
	var connection = mysql.createConnection({
        host     : '127.0.0.1',
        user     : 'root',
        password : '',
        database : 'vulner_stats'
});
	var AuthToken = randomstring.generate();
        connection.connect();
	console.log(req.body.email);
        connection.query("INSERT INTO subscribers VALUES("+connection.escape(req.body.email)+",'mysql,php',"+mysql.escape(AuthToken)+",'FALSE')", function(err, rows, fields) {
                if (err){
                	console.log(err);
			res.status(403).send("Not Authorized");
                	connection.end();
		}else{

                	connection.end();
        
			res.status(200).send("Subscribed");
		}
	});

	
});
app.listen(PORT);
console.log('Server is Listening at:' + PORT);
